@page "{id:int}"
@model Booker.Pages.EditModel
@{
    ViewData["Title"] = "Edytuj ogłoszenie";
    const string include = "#edit-form :not([name = '__RequestVerificationToken'])";
}

<article>
    <h1>Edytuj ogłoszenie:</h1>

    @if (Model.ItemToEdit == null)
    {
        <div class="alert alert-danger" role="alert">
            Ogłoszenie nie zostało znalezione lub nie masz uprawnień do jego edycji.
        </div>
    }
    else
    {
        <form method="post" enctype="multipart/form-data" id="edit-form" class="upload-form" data-in-summary="" hx-on:submit="event.preventDefault(); showConfirmSaveModal(event);">
            <div class="grid">
                <!-- LEFT: Image Preview -->
                <section>
                    <label asp-for="Input.Images">Zmień zdjęcia książki (opcjonalnie):</label>
                    <input type="file" asp-for="Input.Images" accept="image/*" multiple hx-on:change="handleImageUpload(this)">
                    <small>
                        <span asp-validation-for="Input.Images"></span>
                        <span id="imageErrorMsg"></span>
                    </small>

                    <div class="image-preview-container">
                        @* Render existing images using same layout as Add page *@
                        <div class="books-image-layout">
                            <div class="books-image-layout__top">
                                <div class="books-image-layout__main">
                                    @if ((Model.ItemToEdit.Photo ?? "").Split(';', StringSplitOptions.RemoveEmptyEntries).FirstOrDefault() is string mainImg)
                                    {
                                        <img src="@mainImg" alt="Główne zdjęcie książki" class="book-image-preview active" />
                                        <span>Główne zdjęcie</span>
                                    }
                                </div>

                                <div class="books-image-layout__side">
                                    @{
                                        var sideImages = (Model.ItemToEdit.Photo ?? "").Split(';', StringSplitOptions.RemoveEmptyEntries).Skip(1).Take(2);
                                    }
                                    @foreach (var img in sideImages)
                                    {
                                        <img src="@img" alt="Dodatkowe zdjęcie książki" class="book-image-preview active" />
                                    }
                                </div>
                            </div>

                            @if ((Model.ItemToEdit.Photo ?? "").Split(';', StringSplitOptions.RemoveEmptyEntries).Skip(3).Any())
                            {
                                <div class="books-image-layout__bottom">
                                    @{
                                        var bottomImages = (Model.ItemToEdit.Photo ?? "").Split(';', StringSplitOptions.RemoveEmptyEntries).Skip(3).Take(3);
                                    }
                                    @foreach (var img in bottomImages)
                                    {
                                        <img src="@img" alt="Dodatkowe zdjęcie książki" class="book-image-preview active" />
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div asp-validation-summary="ModelOnly"></div>
                </section>

                <!-- RIGHT: Form Inputs -->
                <section>
                    <span hx-get="?handler=Params&firstLoad=true" hx-trigger="load" hx-include="@include" hx-swap="delete"></span>

                    <label asp-for="Input.Title">Tytuł książki:</label>
                    <select asp-for="Input.Title" asp-items="Model.Books"></select>
                    <small><span asp-validation-for="Input.Title"></span></small>

                    <label asp-for='Input.Subject'>Przedmiot:</label>
                    <select asp-for='Input.Subject' asp-items="Model.Subjects"></select>
                    <small><span asp-validation-for="Input.Subject"></span></small>

                    <label asp-for='Input.Grade'>Klasa:</label>
                    <select asp-for='Input.Grade' asp-items="Model.Grades"></select>
                    <small><span asp-validation-for="Input.Grade"></span></small>

                    <label asp-for='Input.Level'>Poziom:</label>
                    <select asp-for='Input.Level' asp-items="Model.Levels"></select>
                    <small><span asp-validation-for="Input.Level"></span></small>

                    <label asp-for="Input.Description">Opis ogłoszenia:</label>
                    <textarea asp-for="Input.Description" rows="4" maxlength="200"></textarea>
                    <small><span class="char-count">0 / 200</span></small>

                    <label asp-for="Input.State">Stan książki:</label>
                    <textarea asp-for="Input.State" rows="3" maxlength="40"></textarea>
                    <small><span asp-validation-for="Input.State"></span><span class="char-count" style="text-align:right;">0 / 40</span></small>

                    <label asp-for="Input.Price">Cena:</label>
                    <input asp-for="Input.Price" placeholder="PLN">
                    <small><span asp-validation-for="Input.Price"></span></small>

                    <div class="grid">
                        <button type="submit" role="button">Zapisz zmiany</button>
                        <button type="button" role="button" class="secondary" onclick="showConfirmDeleteModal(@Model.ItemToEdit.Id)">Usuń ogłoszenie</button>
                    </div>
                </section>
            </div>
        </form>
    }
</article>

<dialog id="confirmSaveModal" aria-labelledby="confirm-save-title" aria-modal="true">
    <article>
        <h2 id="confirm-save-title">Potwierdź zapis</h2>
        <p>Czy na pewno chcesz zapisać zmiany w tym ogłoszeniu?</p>
        <footer>
            <button onclick="this.closest('dialog').close();" class="secondary">Anuluj</button>
            <button onclick="document.getElementById('edit-form').submit();">Zapisz</button>
        </footer>
    </article>
</dialog>

<dialog id="confirmDeleteModal" aria-labelledby="confirm-delete-title" aria-modal="true">
    <article>
        <h2 id="confirm-delete-title">Potwierdź usunięcie</h2>
        <p>Czy na pewno chcesz trwale usunąć to ogłoszenie? Tej operacji nie można cofnąć.</p>
        <footer>
            <div class="grid">
                <button onclick="this.closest('dialog').close();" class="secondary">Anuluj</button>
                <form method="post" asp-page-handler="Delete" id="delete-form-confirm" style="display: contents;">
                    <input type="hidden" name="ItemId" id="deleteItemId" />
                    <button type="submit" role="button">Usuń</button>
                </form>
            </div>
        </footer>
    </article>
</dialog>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize character counters
            document.querySelectorAll('textarea').forEach(ta => {
                ta.addEventListener("input", updateCharCount);
                ta.dispatchEvent(new Event("input"));
            });

            // Initialize existing images for proper layout
            const preview = document.querySelector('.image-preview-container');
            const existingImages = preview.querySelectorAll('img.book-image-preview');
            if (existingImages.length > 0) applyStyling(existingImages.length, preview);
        });

        function showConfirmSaveModal(event) {
            document.getElementById('confirmSaveModal').showModal();
        }

        function showConfirmDeleteModal(itemId) {
            document.getElementById('deleteItemId').value = itemId;
            document.getElementById('confirmDeleteModal').showModal();
        }
    </script>
}
