@page
@model Booker.Areas.Identity.Pages.Account.Manage.ProfilePictureUploadModel
@{
    ViewData["Title"] = "Prześlij zdjęcie profilowe";
}

<h3 class="profile-page-title">Zarządzaj swoim zdjęciem profilowym</h3>

@if (!string.IsNullOrEmpty(TempData["SuccessMessage"] as string))
{
    <div class="alert alert-success" role="alert">
        @TempData["SuccessMessage"] 🥳
    </div>
}
@if (!ViewData.ModelState.IsValid && ViewData.ModelState.Any(m => m.Value.Errors.Any()))
{
    <div class="alert alert-danger" role="alert">
        <h6 class="alert-heading">Wystąpiły błędy:</h6>
        <ul>
            @foreach (var modelState in ViewData.ModelState.Values)
            {
                foreach (var error in modelState.Errors)
                {
                    <li>@error.ErrorMessage</li>
                }
            }
        </ul>
    </div>
}

<section class="main-profile-section">
    <div class="profile-circle-preview">
        <img id="currentProfilePictureDisplay"
             src="@(string.IsNullOrEmpty(Model.CurrentProfilePictureUrl) ? "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" : Model.CurrentProfilePictureUrl)"
             alt="Aktualne zdjęcie profilowe">
    </div>
    <button type="button" class="contrast change-photo-button" onclick="document.getElementById('editPhotoModal').showModal()">Zmień zdjęcie profilowe</button>
</section>

<dialog id="editPhotoModal">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('editPhotoModal').close(); resetCroppingState();"></button>
            <h2>Prześlij i dostosuj nowe zdjęcie</h2>
        </header>
        <form method="post" enctype="multipart/form-data" id="profile-picture-form">
            <div class="grid">
                <section>
                    <label for="imageInput" class="custom-file-upload">
                        Wybierz plik ze zdjęciem 📂
                    </label>
                    <input type="file" id="imageInput" accept="image/*">
                    <small><span asp-validation-for="Input.Image"></span></small>

                    <div class="canvas-container">
                        <img id="imageToCrop" style="max-width: 100%;">
                    </div>

                    <div class="controls-group">
                        <button type="button" class="secondary" id="zoomIn">Powiększ ➕</button>
                        <button type="button" class="secondary" id="zoomOut">Zmniejsz ➖</button>
                        <button type="button" class="secondary" id="rotateLeft">Obróć w lewo 🔄</button>
                        <button type="button" class="secondary" id="rotateRight">Obróć w prawo 🔄</button>
                        <button type="button" class="secondary" id="resetCropper">Resetuj ↩️</button>
                    </div>
                    <input type="hidden" name="Input.Image" id="processedImageInput">
                    <input type="hidden" name="Input.FileName" id="fileNameInput">
                </section>
            </div>
            <footer>
                <button type="submit" class="primary" id="submitButton" disabled>Prześlij i zapisz zdjęcie 💾</button>
            </footer>
        </form>
    </article>
</dialog>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        const imageInput = document.getElementById('imageInput');
        const imageToCrop = document.getElementById('imageToCrop');
        const currentProfilePictureDisplay = document.getElementById('currentProfilePictureDisplay');
        const processedImageInput = document.getElementById('processedImageInput');
        const fileNameInput = document.getElementById('fileNameInput');
        const submitButton = document.getElementById('submitButton');
        const editPhotoModal = document.getElementById('editPhotoModal');

        let cropper;
        let currentBlob = null;
        const DEFAULT_PROFILE_PICTURE = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png";

        function initializeCropper(imageElement) {
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(imageElement, {
                aspectRatio: 1,
                viewMode: 1,
                dragMode: 'move',
                autoCropArea: 0.8,
                movable: true,
                zoomable: true,
                rotatable: true,
                scalable: true,
                background: false,
                cropBoxResizable: false,
                cropBoxMovable: false,
                minCropBoxWidth: 100,
                minCropBoxHeight: 100,
                ready() {
                    updatePreviewAndBlob();
                },
                crop() {
                    updatePreviewAndBlob();
                }
            });
        }

        function updatePreviewAndBlob() {
            if (!cropper || !imageToCrop.src) {
                currentProfilePictureDisplay.src = DEFAULT_PROFILE_PICTURE;
                submitButton.disabled = true;
                processedImageInput.value = '';
                currentBlob = null;
                return;
            }

            const croppedCanvas = cropper.getCroppedCanvas({
                width: 200,
                height: 200,
                fillColor: '#fff',
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high',
            });

            currentProfilePictureDisplay.src = croppedCanvas.toDataURL('image/png');

            croppedCanvas.toBlob((blob) => {
                currentBlob = blob;
                processedImageInput.value = '';
                submitButton.disabled = !currentBlob;
            }, 'image/png', 0.8);
        }

        function resetCroppingState() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            imageToCrop.src = '';
            imageInput.value = '';
            fileNameInput.value = '';
            currentProfilePictureDisplay.src = currentProfilePictureDisplay.dataset.defaultSrc || DEFAULT_PROFILE_PICTURE;
            submitButton.disabled = true;
            processedImageInput.value = '';
            currentBlob = null;
        }

        imageInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                const maxSize = 5 * 1024 * 1024;

                if (!allowedTypes.includes(file.type)) {
                    displayMessage('Dozwolone są tylko pliki JPG, PNG lub GIF.', 'danger');
                    this.value = '';
                    resetCroppingState();
                    return;
                }

                if (file.size > maxSize) {
                    displayMessage('Plik jest zbyt duży (maks. 5MB).', 'danger');
                    this.value = '';
                    resetCroppingState();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    imageToCrop.src = e.target.result;
                    fileNameInput.value = file.name;
                    initializeCropper(imageToCrop);
                };
                reader.readAsDataURL(file);
            } else {
                resetCroppingState();
            }
        });

        document.getElementById('zoomIn').addEventListener('click', () => {
            if (cropper) cropper.zoom(0.1);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            if (cropper) cropper.zoom(-0.1);
        });

        document.getElementById('rotateLeft').addEventListener('click', () => {
            if (cropper) cropper.rotate(-90);
        });

        document.getElementById('rotateRight').addEventListener('click', () => {
            if (cropper) cropper.rotate(90);
        });

        document.getElementById('resetCropper').addEventListener('click', () => {
            if (cropper) cropper.reset();
        });

        document.getElementById('profile-picture-form').addEventListener('submit', async function (event) {
            event.preventDefault();

            if (!currentBlob) {
                displayMessage('Proszę wybrać i dostosować zdjęcie przed przesłaniem.', 'danger');
                return;
            }

            const formData = new FormData();
            formData.append('Input.Image', currentBlob, fileNameInput.value || 'profile_picture.png');

            const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            if (antiForgeryToken) {
                formData.append('__RequestVerificationToken', antiForgeryToken);
            }

            try {
                const response = await fetch(this.action, {
                    method: this.method,
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        displayMessage('Wystąpił błąd podczas przesyłania zdjęcia. Spróbuj ponownie.\nSzczegóły: ' + (errorData.message || JSON.stringify(errorData)), 'danger');
                    } catch (e) {
                        displayMessage('Wystąpił błąd podczas przesyłania zdjęcia. Spróbuj ponownie.\nSzczegóły: ' + errorText, 'danger');
                    }
                    throw new Error(errorText);
                }

                editPhotoModal.close();
                window.location.href = window.location.href;
            } catch (error) {
            }
        });

        function displayMessage(message, type) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `alert alert-${type}`;
            messageContainer.setAttribute('role', 'alert');
            messageContainer.innerHTML = message;

            const mainSection = document.querySelector('.main-profile-section');
            if (mainSection) {
                mainSection.parentNode.insertBefore(messageContainer, mainSection);
            } else {
                document.body.prepend(messageContainer);
            }

            setTimeout(() => {
                messageContainer.remove();
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            currentProfilePictureDisplay.dataset.defaultSrc = currentProfilePictureDisplay.src;
            if (!currentProfilePictureDisplay.src || currentProfilePictureDisplay.src.includes('blank-profile-picture-973460_1280.png')) {
                currentProfilePictureDisplay.src = DEFAULT_PROFILE_PICTURE;
            }
        });
    </script>
}